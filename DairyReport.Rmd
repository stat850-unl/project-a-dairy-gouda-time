---
title: "Visual Exploration of Dairy Products in the United States"
author: "Becca Furbeck, Kassidy Buse, Samantha Teten"
output: markdowntemplates::skeleton
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("pagedown")
#install.packages("pagedown")
#remotes::install_github("hrbrmstr/markdowntemplates") 
#uncomment to get packages for pretty document

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

## Setting the stage

Our consulting team has been approached by a wealthy business person. Our client, who just happens to love dairy products, has had the life-long dream of opening their own creamery. They are unsure of where to start, so we have been hired to aide in decision making throughout the process. Our major points of concern are where to locate the creamery, what products to make, and what difficulties could arise or things should we be aware of in terms of food safety. 

We have combed the USDA and FDA data to make recommendations to ensure their dreams become a reality.

## Location, location, location

When deciding on a location for a creamery, several factors need to be taken into consideration. This includes land costs, government regulations (such as environmental and food safety laws), tax rates, and consumer demand. However, above all these factors, milk acquisition is the most important aspect of location decision making. Without milk to process, a creamery is essentially useless. It is true that there is milk produced in 49 states - it used to be 50 until the sole dairy on the island of Hawaii was shutdown because of its environmental impact...and smell. However, it is costly to haul milk, so you would want to place a creamery in a location that is not only in close proximity to dairies but also close to a large supply of milk.  

#### Introducing the data

```{r, include = FALSE}
# silet
urlfile <- "https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-01-29/state_milk_production.csv"
dairycsv <- read.csv(urlfile)
dairybystate <- as.data.frame(dairycsv)
```

```{r, echo = FALSE}
head(dairybystate)
```

This data set includes the milk produced, annually, for each of the 50 states from 1970 to 2017. It consists of 2400 rows with 4 variables. As you can see, there is a column depicting the region in which each state lies. While this isn't necessarily important to our location analysis, it does become important in the "real world" as each region has it's own dairy association that operates within it. These associations allocate check-off dollars, a set dollar amount that is taken out of each milk check based on the amount of milk produced, to help with the promotion of dairy product consumption. The national check-off dollar amount is held at a constant value, but each region can set its own check-off price. 

#### Historical milk production

To best get an idea of where to build the creamery, we can't just look at where the most milk is being produced now. While the milk produced per cow is fairly consistent across the United States, the number of cows in each state changes fairly frequently. These changes reflect differences in milk prices and feed costs as well as the expansion and construction of processing plants. Thus, we need to focus more on historical trends instead of current values. 

##### Channel your inner Indiana Jones

Before we can start an analysis, we need to explore the data

```{r}
range(dairybystate$milk_produced)
```
This shows us that within the entire data set, we have a minimum milk produced of 3,000,000 lbs and a maximum of 42,339,000,000 lbs. Yikes, that's a large range. Just out of curiousity, let's find out who they are.

```{r}
which.min(dairybystate$milk_produced)
which.max(dairybystate$milk_produced)
```

Wonder who the minimum is (let's be honest...the low is either Alaska or Hawaii)
```{r}
dairybystate[2199,]
```
Like I said, Alaska or Hawaii. 
I'm betting the high is California (because happy cows are in CA...or just very hot ones).
```{r}
dairybystate[2248,]
```

Of course, it was California. On top of that, 2014 was a great year for dairy in California with high milk prices and government incentives for agricultural expansion, so that isn't surprising at all.

##### Questionable cartography

To best get a visualization on the changes in production across the US, a map that clearly shows all 50 states trumps a line plot with 50 lines to try and differentiate from each other. But with a map, you don't want to generate one for each of the 48 years this data spans. That's just overwhelming. It is also obviously not ideal to plot every year, because with a range this large, the continuous fill scale would be so broad that it wouldn't accurately depict the data. So, we have to break this down. 

###### Making milestones

To keep things concise, we are going to focus on milestone years: 1970, 1980, 1990, 2000, 2010, and 2017. 
```{r}
library(tidyverse)
dairymile <- dairybystate %>% filter(year %in% c("1970", "1980", "1990", "2000", "2010", "2017"))
```

###### Setting scale

To help with determining the range of the scale, we are now going to find the ranges of these years. 
```{r, echo = FALSE}
range(dairymile$milk_produced)
```

So it looks like our minimum value is 3,000,000 and our maximum value is 40,385,000,000. 

Well, that didn't help much, but logically, we can eliminate the lower bounds because we aren't interested in these small states with limited supply, we want the milk. 

###### Creating the map

```{r, include = FALSE}
library(usmap)
library(ggplot2)
library(maps)

usa <- plot_usmap(regions = "states", data = dairymile, values = "milk_produced", color = "black") + 
  scale_fill_continuous(low = "purple", high = "orange", name = "Production, lb", label = scales::comma, breaks = c(10000000000, 20000000000, 30000000000, 40000000000), limits = c(2500000000, 45000000000)) +
  labs(title = "Dairy Production in the United States") + 
  theme(panel.background = element_rect(color = "black", fill = "white"), legend.position = "right")

usadairy = usa + facet_wrap(~ year, ncol = 3) +
    theme(legend.position = "right",
          strip.background = element_blank()) +
    labs(fill = "Milk Produced, lb",
         title = "Milk produced by state from 1970 to 2017")
```

```{r, echo = FALSE}
usadairy
```
As you can see, the clear winners here are Wisconsin and California. Number 3 is up for debate. It seems that our contenders are Texas, Minnesota, Iowa, Michigan, Ohio, Pennsylvania, and New York. This is a bit easier to work with.

```{r, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='80%'}
library(ggplot2)
library(hrbrthemes)

dairycontest <- dairybystate %>% 
  filter(state %in% c("Texas", "Minnesota", "Iowa", "Michigan", "Ohio", "Pennsylvania", "New York"))

```

## Profitable Products 

Intro goes here

### Introducing the Data

We are using 2 main entities for data.

The first portion is provided by the USDA ERS:
https://www.ers.usda.gov/data-products/dairy-data/
Variables in these datasets (see CSVs below) are mainly numeric, pertaining to production and sales of dairy products. 

### Data Manipulation and Cleaning
```{r}
library(readr)
library(tidyverse)

ice_cream_header<-c("Year","RetailPrice_Dollars","FarmValue_Dollars","FarmShare_Percent","","")
ice_cream <- read_csv("ice_cream.csv", 
                       col_names = ice_cream_header, 
                       col_types = "dddd_", skip = 3) %>%
  filter(Year <= 2018) %>%
  select(-5)

whole_milk_header<-c("Year","RetailPrice_Dollars","FarmValue_Dollars","FarmShare_Percent","","")
whole_milk <- read_csv("whole_milk.csv", 
                       col_names = whole_milk_header, 
                       col_types = "dddd_", skip = 3) %>%
  filter(Year <= 2018) %>%
  select(-5)

butter_header<-c("Year","RetailPrice_Dollars","FarmValue_Dollars","FarmShare_Percent")
butter <- read_csv("butter.csv", 
                       col_names = butter_header, 
                       col_types = "dddd_", skip = 3) %>%
  filter(Year <= 2018) %>%
  select(-4)

cheese_header<-c("Year","RetailPrice_Dollars","FarmValue_Dollars","FarmShare_Percent")
cheese <- read_csv("cheese.csv", 
                       col_names = cheese_header, 
                       col_types = "dddd_", skip = 3) %>%
  filter(Year <= 2018) %>%
  select(-4)

consupt_header<-c("Year","Fluid","Cheese","Butter","RegularIceCream","LowFatIceCream")
pcconsp <- read_csv("pcconsp.csv", 
                       col_names = consupt_header, 
                       col_types = "dddddd", skip = 6) %>%
  filter(Year <= 2019)

head(whole_milk)
NROW(whole_milk)

butter<-butter%>%
  mutate(FarmShare_Percent=FarmValue_Dollars/RetailPrice_Dollars*100)

cheese<-cheese%>%
  mutate(FarmShare_Percent=FarmValue_Dollars/RetailPrice_Dollars*100)

groupfunct<-function(x,name){
  x<-x%>%
    mutate(Product=X)
}

cheese<-cheese%>%
  mutate(Product="Cheese")
butter<-butter%>%
  mutate(Product="Butter")
ice_cream<-ice_cream%>%
  mutate(Product="Ice_Cream")
whole_milk<-whole_milk%>%
  mutate(Product="Whole_Milk")

AllProducts<-rbind(butter,cheese,ice_cream,whole_milk)
AllProducts


```

### Data Exploration
#### Retail Prices
```{r prices, include=FALSE}
retail<- ggplot(data=AllProducts, aes(x=Year, y=RetailPrice_Dollars, group=Product,color=Product)) +
  geom_line(aes(color=Product))+
  geom_point()+
  geom_smooth(method=lm,formula='y~x', se= FALSE)+
  scale_color_brewer(type='seq',palette='PuOr')
```
```{r retailplot, echo=FALSE}
retail
```

#### Farm Value

```{r farmvaluesilent, include=FALSE}
library(ggplot2)
library(reshape)
library(gganimate)

farmvalue<-ggplot(data=AllProducts, aes(x=Year, y=FarmValue_Dollars, group=Product,color=Product)) +
  geom_line(aes(color=Product))+
  geom_point()+
  geom_smooth(method=lm,formula='y~x', se= FALSE)+
  scale_color_brewer(type='div',palette='PuOr')
```
```{r farmvalue, echo=FALSE}
farmvalue
```


#### Farm Share

```{r farmsilent, include=FALSE}
to_plot <- data.frame(x=AllProducts$Product,RetailPriceDollars=AllProducts$RetailPrice_Dollars,FarmValueDollars=AllProducts$FarmValue_Dollars)
melted<-melt(to_plot, id="x")
share<-ggplot(melted,aes(x=x,y=value,group=x,fill=variable)) + 
  geom_bar(stat="identity",position = "identity")+
  scale_fill_brewer(type='seq',palette='PuOr')+
  labs(title="Farm Share of Retail Price by Product",x="Product",y="Value ($)")
```
```{r shareplot,echo=FALSE}
share
```

### Farm Share Percentage by Product
```{r productsilent, include=FALSE}
productcomp<- AllProducts %>%
  mutate(Product = fct_reorder(Product, FarmShare_Percent, .fun='median')) %>%
  ggplot( aes(x=reorder(Product, FarmShare_Percent), y=FarmShare_Percent, fill=Product)) + 
    geom_boxplot() +
    xlab("Product") +
    theme(legend.position="none") +
    xlab("")+
  scale_fill_brewer(type='seq',palette='PuOr')
```
```{r productplot, echo=FALSE}
productcomp
```

#### Dairy Consumption Per Capita

```{r consumptionsilent,include=FALSE}

colors <- c("Fluid" = "mediumorchid4", "Cheese" = "mediumorchid", "Butter" = "magenta","RegularIceCream"="sienna1","LowFatIceCream"="sienna3")
ggplot(data=pcconsp, aes(x=Year))+
  geom_line(aes(y=Fluid/10,color="Fluid"), size = 2)+
  geom_line(aes(y=Cheese,color="Cheese"), size =2)+
  geom_line(aes(y=Butter,color="Butter"), size = 2)+
  geom_line(aes(y=RegularIceCream,color="RegularIceCream"), size = 2)+
  geom_line(aes(y=LowFatIceCream, color="LowFatIceCream"), size =2)+
  labs(title="Diary Product Consumption Per Capita", x = "Year",
      y = "Consumption (lbs), 
      Fluid is in tens of pounds",
      color = "Legend")  +
  scale_color_manual(values = colors)+
  transition_reveal(Year)

consumption<-anim_save("DairyConsumption")
```
![ ](ConsumptionGraph.gif)

## Product Recommendations

- Get a contract with Kwik Trip to sell milk and butter
- Make your own specialty cheese and ice cream to sell online or store front
- Hire Becca to pair your cheeses with meat in charcuterie board / snacking application

```{r cheesepic, echo=FALSE,out.width = '25%'}
knitr::include_graphics("cheesepic.jpg")
```

### Conclusions
