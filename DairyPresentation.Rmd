---
title: "Visual Exploration of Dairy Products in the United States" 
author: "Becca Furbeck, Kassidy Buse, Samantha Teten"
date: "11/21/2020"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


## The Set-Up {data-background=background.jpg data-background-size=cover}
<div class= "black">

Our team has been approached by a business person who happens to love dairy products! They are interested in starting a dairy to live out their childhood dreams, but are not sure where to start. We combed the USDA and FDA data to make recommendations to ensure they get the best dairy possible. 
</div>

## HOLY COW!


There is a lot to consider! Maybe exploratory analysis can help!

```{r cows, echo = FALSE, warning=FALSE, message=FALSE, fig.align='center'}
library(magick)
library(magrittr)
library(purrr)

cowsgif<-list.files("Cow Pics PNG", pattern = '*.png', full.names = TRUE) %>% 
        image_read() %>% 
        image_join() %>% 
        image_scale("x500")%>%
        image_animate(fps=2) 

cowsgif
```

## Questions to Answer 

- Where is the best place in the United States to run a dairy operation?
- What products are the most profitable?
- What are hazards to look out for during production to avoid recalls?


## Slide with R Output

```{r cars, echo = TRUE}
summary(cars)
```

## Slide with Plot

```{r pressure}
plot(pressure)
```



## Where should we operate?

Kassidy introduces her dataset

## Kassidy Plot

hooray U.S.A.

## Kassidy recommendations

put your farm in a state where you can make money yo

## What Products should we make?

Sam introduces her dataset

## Sam Plot

## Sam Recommendations

make this product and make mad money yo

## What should the producer look out for?

In order to determine possible issues during the processes of products, we utilized the FDA food recall database listings from 2016-2020. These were procured as a .csv for 2018-2020, and scraped from archived FDA websites. 

## FDA Dataset
1914 entries once all years are merged. 
Variables include:

- Date (mm/dd/yyyy)
- Company Name
- Product Category
- Product Name
- Reason for Recall


```{r, include=FALSE}
#Hello and welcome to by big silent R chunk for reproduciblity's sake. include=FALSE so none of this will be printed, but I need it to make objects below. 

#2020-2018 are on current listing exportable as excel from a jquery table that didn't want scraped...it goes into git repo as FDA.csv it that case
FDAcurrentsite="https://www.fda.gov/safety/recalls-market-withdrawals-safety-alerts"
FDA1<-read.csv("FDA.csv", skip = 1)

library(XML)
library(dplyr)
library(purrr)
#Archived 2017 has 14 pages
FDA2017site='http://wayback.archive-it.org/7993/20180125100707/https://www.fda.gov/Safety/Recalls/ArchiveRecalls/2017/default.htm?Page=14'
#Archived 2016 has 18 pages
FDA2016site = 'http://wayback.archive-it.org/7993/20180125100804/https://www.fda.gov/Safety/Recalls/ArchiveRecalls/2016/default.htm?Page=17'

tbls_xml <- readHTMLTable(FDA2017site)

tbls16<-capture.output(for (i in 1:14){
  print(paste0('http://wayback.archive-it.org/7993/20180125100707/https://www.fda.gov/Safety/Recalls/ArchiveRecalls/2017/default.htm?Page=',i,''))
})

tbls17<-capture.output(for (i in 1:18){
  (print(paste0('http://wayback.archive-it.org/7993/20180125100804/https://www.fda.gov/Safety/Recalls/ArchiveRecalls/2016/default.htm?Page=',i,'')))
})

FDAoldtbl<-c(tbls16,tbls17)
FDAoldtabl<-as.data.frame(FDAoldtbl)
front<-gsub("^.....","",FDAoldtabl$FDAoldtbl)
back<-gsub('.{1}$','', front)
OldJoin<-back %>% map(readHTMLTable)

Old<-rbind(OldJoin[[1]][["NULL"]],OldJoin[[2]][["NULL"]],OldJoin[[3]][["NULL"]],OldJoin[[4]][["NULL"]],OldJoin[[5]][["NULL"]],OldJoin[[6]][["NULL"]],OldJoin[[7]][["NULL"]],OldJoin[[8]][["NULL"]],OldJoin[[9]][["NULL"]],OldJoin[[10]][["NULL"]],OldJoin[[11]][["NULL"]],OldJoin[[12]][["NULL"]],OldJoin[[13]][["NULL"]],OldJoin[[14]][["NULL"]],OldJoin[[15]][["NULL"]],OldJoin[[16]][["NULL"]],OldJoin[[17]][["NULL"]],OldJoin[[18]][["NULL"]],OldJoin[[19]][["NULL"]],OldJoin[[20]][["NULL"]],OldJoin[[21]][["NULL"]],OldJoin[[22]][["NULL"]],OldJoin[[23]][["NULL"]],OldJoin[[24]][["NULL"]],OldJoin[[25]][["NULL"]],OldJoin[[26]][["NULL"]],OldJoin[[27]][["NULL"]],OldJoin[[28]][["NULL"]],OldJoin[[29]][["NULL"]],OldJoin[[30]][["NULL"]],OldJoin[[31]][["NULL"]],OldJoin[[32]][["NULL"]])
Old<-as.data.frame(Old)


Old<-Old %>% select(-" Details/Photo ") 
FDA1<-FDA1 %>% select(-"Product.Type")

matchnames<-c("Date","Brand.Name.s.","Product.Description","Recall.Reason.Description","Company.Name")
colnames(Old)<-matchnames
Old<-as.data.frame(Old)
FDA1<-as.data.frame(FDA1)
FDA<-rbind(Old,FDA1)

library(purrr)
library(htmltab)
library(tidyr)
url = 'https://en.wikipedia.org/wiki/List_of_dairy_products'
url2 = "https://en.wikipedia.org/wiki/List_of_cheeses"

tbls <- map2(url, 1:23, htmltab, rm_nodata_cols =F)
tblname<-map(tbls, 1)
dairy1<-unlist(tblname)

tbls2 <- map2(url2, 1:23, htmltab, rm_nodata_cols =F)
tblname2<-map(tbls2, 1)
dairy2<-unlist(tblname2)

dairy<-c(dairy1,dairy2)

library(stringr)
library(dplyr)

dairy
dairy2<-print(dairy[dairy!="So"])     

matchesdairy <- grepl(paste(dairy2, collapse = "|"), FDA$Product.Description)
matchesdairy2<-print(FDA$Product.Description[matchesdairy])

getout<-c("Butter nut","Butternut", "Peanut", "Non-Dairy","Butterfly", "Beanit","Panque","Sunflower","Nut", "Cashew", "Imitation")

filtereditems <- grepl(paste(getout, collapse = "|"), matchesdairy2)
filtereditems2<-print(matchesdairy2[filtereditems==F])

DairySet<-FDA %>% filter(Product.Description %in% filtereditems2)

library(lubridate)
DairySet<-DairySet %>% mutate(Date = mdy(Date))%>%mutate(year = lubridate::year(Date),
                    month = lubridate::month(Date),
                    day = lubridate::day(Date))
DairySet$month<-month.abb[DairySet$month]

library(stringr)
library(tm)
library(RColorBrewer)
library(wordcloud)

nopunct<-gsub('[[:punct:] ]+',' ',DairySet$Recall.Reason.Description)
nopunct<-trimws(nopunct)
wordsextract<-str_split(nopunct, " ")
wordsextract<-unlist(wordsextract)

docs <- Corpus(VectorSource(wordsextract))
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
wordclouddf <- data.frame(word = names(words),freq=words)


library(ggplot2)
recallplot<-ggplot(DairySet, aes(month))+geom_histogram(aes(fill=..count..),stat = "count")+ scale_x_discrete(limits = month.abb)+        scale_fill_gradient("Count", low = "purple", high = "orange")+ylab("Number of Recalls")+xlab("Month")+ggtitle("Recalls of U.S. Dairy Products during 2016-2020")

```

## Dataset is a little ambiguous...
For example, one entry was listed as Whole Foods, instead of a product category, so I decided to rely on filtering I performed instead. 

```{r FDA, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(printr)
wholefoods<-FDA %>% filter(Product.Description=="8-20-2020, Whole Foods Market")
head(wholefoods)
```

## Wikipedia scrape
I scraped the names of dairy products and cheese listed in an HTML table on wikipedia to filter the dataset. 
```{r, echo=FALSE}


```

## Wordcloud Plot
```{r wordplot, echo=FALSE, warning=FALSE}
set.seed(5658) # for reproducibility 
wordcloud(words = wordclouddf$word, freq = wordclouddf$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.20,colors=brewer.pal(8, "PuOr"))
#purple and orange to be color friendly
```

## Monthly Occurances - Major Outbreak Plot
```{r recallplot, echo=FALSE}
recallplot
```

## Becca Recommendations

Don't mess with *Listeria* yo


